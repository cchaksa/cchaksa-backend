<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- ===== 공통 프로퍼티 (프로파일별로 덮어씌워짐) ===== -->
    <springProperty scope="context" name="LOG_PATH"      source="logging.file.path" defaultValue="logs"/>
    <springProperty scope="context" name="FILE_NAME"     source="logging.file.name" defaultValue="app.log"/>
    <springProperty scope="context" name="GZIP"          source="logging.archive.gzip" defaultValue="false"/>
    <springProperty scope="context" name="MAX_HISTORY"   source="logging.archive.max-history" defaultValue="7"/>
    <springProperty scope="context" name="ROOT_LEVEL"    source="logging.root.level" defaultValue="WARN"/>

    <!-- ===== 프로파일별 프로퍼티 오버라이드 ===== -->
    <springProfile name="local">
        <springProperty scope="context" name="LOG_PATH"    source="logging.file.path" defaultValue="logs"/>
        <springProperty scope="context" name="FILE_NAME"   source="logging.file.name" defaultValue="app.log"/>
        <springProperty scope="context" name="GZIP"        source="logging.archive.gzip" defaultValue="false"/>
        <springProperty scope="context" name="MAX_HISTORY" source="logging.archive.max-history" defaultValue="7"/>
        <springProperty scope="context" name="ROOT_LEVEL"  source="logging.root.level" defaultValue="INFO"/>
    </springProfile>

    <springProfile name="dev">
        <springProperty scope="context" name="LOG_PATH"    source="logging.file.path" defaultValue="/home/ubuntu/monitoring/logs"/>
        <springProperty scope="context" name="FILE_NAME"   source="logging.file.name" defaultValue="app.log"/>
        <springProperty scope="context" name="GZIP"        source="logging.archive.gzip" defaultValue="false"/>
        <springProperty scope="context" name="MAX_HISTORY" source="logging.archive.max-history" defaultValue="7"/>
        <springProperty scope="context" name="ROOT_LEVEL"  source="logging.root.level" defaultValue="WARN"/>
    </springProfile>

    <springProfile name="prod">
        <springProperty scope="context" name="LOG_PATH"    source="logging.file.path" defaultValue="/home/ubuntu/monitoring/logs"/>
        <springProperty scope="context" name="FILE_NAME"   source="logging.file.name" defaultValue="app.log"/>
        <springProperty scope="context" name="GZIP"        source="logging.archive.gzip" defaultValue="true"/>
        <springProperty scope="context" name="MAX_HISTORY" source="logging.archive.max-history" defaultValue="30"/>
        <springProperty scope="context" name="ROOT_LEVEL"  source="logging.root.level" defaultValue="WARN"/>
    </springProfile>

    <!-- ===== 정적 리소스/Swagger 로그 레벨 제한 ===== -->
    <logger name="org.springdoc" level="WARN"/>
    <logger name="org.springframework.web.servlet.resource" level="WARN"/>

    <!-- ===== 전역 차단 필터: MDC skipLog=true일 경우 로그 출력 안 함 ===== -->
    <turboFilter class="ch.qos.logback.classic.turbo.MDCFilter">
        <MDCKey>skipLog</MDCKey>
        <Value>true</Value>
        <OnMatch>DENY</OnMatch>
        <OnMismatch>NEUTRAL</OnMismatch>
    </turboFilter>

    <!-- ===== prod/dev Appender: 파일 로그 + Sentry ===== -->
    <springProfile name="prod,dev">
        <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_PATH}/${FILE_NAME}</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>${LOG_PATH}/app.%d{yyyy-MM-dd}.log${GZIP.equals("true") ? ".gz" : ""}</fileNamePattern>
                <maxHistory>${MAX_HISTORY}</maxHistory>
                <cleanHistoryOnStart>true</cleanHistoryOnStart>
            </rollingPolicy>

            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <charset>UTF-8</charset>
                <providers>
                    <timestamp>
                        <fieldName>timestamp</fieldName>
                        <timeZone>Asia/Seoul</timeZone>
                    </timestamp>
                    <logLevel><fieldName>level</fieldName></logLevel>
                    <loggerName><fieldName>logger</fieldName></loggerName>
                    <mdc>
                        <includeMdcKeyName>userId</includeMdcKeyName>
                        <includeMdcKeyName>traceId</includeMdcKeyName>
                        <includeMdcKeyName>spanId</includeMdcKeyName>
                        <includeMdcKeyName>className</includeMdcKeyName>
                        <includeMdcKeyName>method</includeMdcKeyName>
                        <includeMdcKeyName>part</includeMdcKeyName>
                    </mdc>
                    <message><fieldName>message</fieldName></message>
                    <throwable>
                        <classNameFieldName>errorCause</classNameFieldName>
                        <messageFieldName>error</messageFieldName>
                        <stackTraceFieldName>stackTrace</stackTraceFieldName>
                        <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                            <rootCauseFirst>true</rootCauseFirst>
                            <maxDepthPerThrowable>50</maxDepthPerThrowable>
                            <maxLength>8000</maxLength>
                            <shortenedClassNameLength>40</shortenedClassNameLength>
                        </throwableConverter>
                    </throwable>
                </providers>
            </encoder>
        </appender>

        <appender name="SENTRY" class="io.sentry.logback.SentryAppender">
            <minimumEventLevel>WARN</minimumEventLevel>
            <minimumBreadcrumbLevel>INFO</minimumBreadcrumbLevel>
        </appender>
    </springProfile>

    <!-- ===== local Appender: 콘솔 로그 ===== -->
    <springProfile name="local">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <charset>UTF-8</charset>
                <providers>
                    <timestamp>
                        <fieldName>timestamp</fieldName>
                        <timeZone>Asia/Seoul</timeZone>
                    </timestamp>
                    <logLevel><fieldName>level</fieldName></logLevel>
                    <loggerName><fieldName>logger</fieldName></loggerName>
                    <message><fieldName>message</fieldName></message>
                </providers>
            </encoder>
        </appender>
    </springProfile>

    <!-- ===== 패키지별 로거 ===== -->
    <logger name="HTTP" level="INFO"/>
    <logger name="com.chukchuk.haksa" level="INFO"/>

    <!-- ===== 루트 로거 설정 ===== -->
    <springProfile name="prod,dev">
        <root level="${ROOT_LEVEL}">
            <appender-ref ref="FILE_JSON"/>
            <appender-ref ref="SENTRY"/>
        </root>
    </springProfile>

    <springProfile name="local">
        <root level="${ROOT_LEVEL}">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

</configuration>